<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>TURBO STREET RACERS ‚Äî QA Bug Hunt Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Overhead neon racer with planted flaws. Students play, spot issues, and fix via prompt engineering." />
<style>
  :root{
    --bg1:#070d1a; --bg2:#0a1226; --ink:#e5e7eb; --muted:#94a3b8; --accent:#60a5fa; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --panel:#0f172a; --border:#233047; --shadow:0 10px 28px rgba(0,0,0,.35);
    --road:#0b1423; --shoulder:#0d1b2a; --line:#1f3a5f;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{max-width:1200px;margin:18px auto 8px;padding:0 14px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  header h1{font-size:20px;margin:0}
  .pill{background:#0d1833;border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px}
  .wrap{max-width:1200px;margin:0 auto;padding:0 14px 34px;display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media (max-width:1050px){.wrap{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .left{padding:12px}
  .section{border:1px solid var(--border);border-radius:12px;background:#0c172e;margin:8px 0}
  .section h3{margin:0;padding:8px 10px;color:var(--muted);font-size:13px;border-bottom:1px solid var(--border)}
  .section .pad{padding:10px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{background:#14213a;border:1px solid #2b3a55;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer}
  button:hover{filter:brightness(1.08)}
  button.primary{background:#16a34a;border-color:#22c55e;color:#07150f;font-weight:700}
  button.ghost{background:transparent;border-color:#334155;color:#cbd5e1}
  input[type="checkbox"]{transform:scale(1.15)}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;border:1px solid #334155;padding:1px 6px;border-radius:6px;background:#0b1428;color:#cbd5e1}
  .stat{background:#0b1428;border:1px solid var(--border);border-radius:12px;padding:10px}
  .stat h4{margin:0 0 2px;font-size:12px;color:var(--muted)}
  .stat .big{font-weight:800;font-size:22px}
  .tiny{font-size:12px;color:var(--muted)}
  .game{position:relative;min-height:560px;padding:10px}
  .canvasWrap{background:#0a1321;border:1px solid var(--border);border-radius:16px;padding:8px;display:grid;grid-template-rows:auto 540px;gap:8px}
  .bar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .tag{padding:4px 10px;border:1px solid var(--border);border-radius:999px;color:#d1d5db;background:#0e1a33}
  canvas{background:#06101b;border:1px solid var(--border);border-radius:12px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0b1428;border:1px solid var(--border);padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;transition:opacity .3s, transform .3s}
  .toast.show{opacity:1;transform:translate(-50%,-6px)}
  footer{max-width:1200px;margin:12px auto 40px;color:var(--muted);font-size:12px;padding:0 14px}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .box{max-width:920px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .modal h2{margin:0 0 6px}
  .ach{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;margin:4px;border-radius:999px;border:1px solid var(--border);background:#0d162a}
  /* On-screen controls (INTENTIONALLY cosmetic only; see ANTI-PATTERN #11) */
  .touch{display:none;position:absolute;bottom:14px;right:14px;gap:8px}
  .touch button{width:56px;height:56px;border-radius:50%}
  @media (max-width:800px){.touch{display:flex}}
</style>
</head>
<body>
<header>
  <h1>üèÅ TURBO STREET RACERS ‚Äî <em>QA Bug Hunt Edition</em></h1>
  <span class="pill">Arcade ‚Ä¢ Nitro ‚Ä¢ Traffic ‚Ä¢ Police</span>
  <span class="pill">Built to be fun‚Ä¶ with deliberate flaws</span>
</header>

<div class="wrap">
  <!-- LEFT: Controls & Stats -->
  <div class="panel left">
    <div class="section">
      <h3>Game Controls</h3>
      <div class="pad row">
        <button class="primary" id="playBtn">‚ñ∂ Play</button>
        <button class="ghost" id="pauseBtn">‚è∏ Pause</button>
        <button class="ghost" id="resetBtn">‚Üª Reset</button>
        <button class="ghost" id="exportBtn">‚¨á Export CSV</button>
      </div>
      <div class="pad tiny">
        Steer: <span class="kbd">‚Üê/‚Üí</span> or <span class="kbd">A/D</span> ‚Ä¢ Throttle: <span class="kbd">‚Üë/‚Üì</span> ‚Ä¢ Nitro: <span class="kbd">Space</span> ‚Ä¢ Pause: <span class="kbd">P</span> ‚Ä¢ Missions: <span class="kbd">M</span>
      </div>
      <div class="pad row tiny">
        <label class="row" style="gap:6px"><input type="checkbox" id="sfxOn" checked /> SFX</label>
        <label class="row" style="gap:6px"><input type="checkbox" id="shakeOn" checked /> Screen shake</label>
      </div>
    </div>

    <div class="section">
      <h3>Scoreboard</h3>
      <div class="pad" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div class="stat"><h4>Score</h4><div class="big" id="score">0</div><div class="tiny">+ distance</div></div>
        <div class="stat"><h4>Nitro</h4><div class="big" id="nitro">‚Äî</div><div class="tiny">hold Space</div></div>
        <div class="stat"><h4>Hits</h4><div class="big" id="hits">0</div><div class="tiny">3 = busted</div></div>
        <div class="stat"><h4>Time</h4><div class="big" id="timer">02:00</div><div class="tiny">round length</div></div>
      </div>
      <div class="pad">
        <div class="tiny">High score: <b id="hs">0</b></div>
        <div id="achWrap" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="section">
      <h3>QA Missions (Press M)</h3>
      <div class="pad tiny">
        Play and list what feels unfair, clunky, or broken.  
        Then craft prompts to patch those exact places (tags in code).
      </div>
    </div>
  </div>

  <!-- RIGHT: Game Area -->
  <div class="panel game">
    <div class="canvasWrap">
      <div class="bar">
        <div class="tag">Police rubberband & hitboxes are‚Ä¶ ‚Äúspicy‚Äù on purpose.</div>
        <div class="tag">Round: <b id="roundName">Neon Express</b></div>
      </div>
      <div style="position:relative">
        <canvas id="game" width="960" height="540" aria-label="Turbo racer canvas"></canvas>
        <!-- Cosmetic-only touch controls (ANTI-PATTERN #11: not wired) -->
        <div class="touch" id="touch">
          <button>‚¨Ö</button><button>‚¨Ü</button><button>‚¨á</button><button>‚û°</button><button>üî•</button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  This build intentionally includes questionable choices (documented in code). Students identify, then fix via prompt engineering (write precise diffs against <code>index.html</code>).
</footer>

<!-- Modals -->
<div class="modal" id="missions">
  <div class="box">
    <h2>QA Missions (discover & fix)</h2>
    <ul class="tiny">
      <li>Steering & Nitro responsiveness</li>
      <li>Unfair spawns & collisions</li>
      <li>Rubberbanding & police logic</li>
      <li>Pause behavior & timers</li>
      <li>Particle performance & SFX volume</li>
      <li>Touch/mobile controls & accessibility</li>
    </ul>
    <div class="row" style="justify-content:flex-end;margin-top:8px"><button id="closeM" class="primary">Close</button></div>
  </div>
</div>

<div class="modal" id="gameOver">
  <div class="box">
    <h2>Round Complete</h2>
    <div id="summary"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px"><button id="againBtn" class="primary">Play again</button></div>
  </div>
</div>

<div class="toast" id="toast">Hello</div>

<script>
/* =========================================================
   TURBO STREET RACERS ‚Äî QA Bug Hunt
   Overhead racer with deliberately "bad" features.
   Controls: Arrow keys / WASD, Space = Nitro, P pause, M missions
========================================================= */

/* ========= Utilities ========= */
const $ = id => document.getElementById(id);
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const rand = (a,b)=>Math.random()*(b-a)+a;
const randi = (a,b)=>Math.floor(rand(a,b+1));
const now = ()=>performance.now();
const toast = (msg)=>{const t=$('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1400);};

let AC;
try{ AC = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
function beep(freq=720, ms=120, type='sine', vol=0.28){ // ANTI-PATTERN #6: volume too high & ignores SFX toggle
  if(!AC /* || !$('sfxOn').checked */) return; // FIXME: honor checkbox
  const o=AC.createOscillator(), g=AC.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=vol;
  o.connect(g); g.connect(AC.destination); o.start();
  setTimeout(()=>{o.stop();}, ms);
}

/* ========= Game State ========= */
const G = {
  running:false, over:false, paused:false,
  W:960, H:540, last:0, dt:0, t:0,
  // Round
  roundLen:120000, endAt:0,
  // Road
  roadX:180, roadW:600, laneN:3, laneX:[], stripeY:0,
  // Player
  p:{x:480,y:420,w:54,h:96, rHitX:62, rHitY:110, // ANTI-PATTERN #1: hitbox bigger than sprite (unfair)
     vx:0, vy:0, speed:220, maxSpeed:360, nitro:100, nitroUntil:0, slipUntil:0, hits:0 },
  // Police
  policeY:640, policeCatch:0, // distance behind screen; lower is closer
  // Entities
  cars:[], coins:[], cones:[], particles:[],
  keys:{}, score:0, high: Number(localStorage.getItem('tsr_high')||0),
  // Spawners (intervals ignore pause) // ANTI-PATTERN #8
  ivCars:null, ivCoins:null, ivCones:null, ivScoreTick:null,
  // Shake
  shakeA:0, shakeT:0,
  // CSV
  events:[]
};

/* ========= Canvas ========= */
const canvas = $('game');
const ctx = canvas.getContext('2d');

/* ========= Input ========= */
window.addEventListener('keydown', e=>{
  if(e.code==='KeyP'){togglePause(); return;}
  if(e.code==='KeyM'){showMissions(); return;}
  if(e.code==='Space'){doNitro(); e.preventDefault(); return;}
  G.keys[e.code] = true;
});
window.addEventListener('keyup', e=>{ G.keys[e.code] = false; });

/* ========= Lifecycle ========= */
$('playBtn').addEventListener('click', start);
$('pauseBtn').addEventListener('click', togglePause);
$('resetBtn').addEventListener('click', reset);
$('exportBtn').addEventListener('click', exportCSV);
$('closeM').addEventListener('click', ()=>$('missions').style.display='none');
$('againBtn').addEventListener('click', ()=>{ $('gameOver').style.display='none'; reset(); start(); });

function start(){
  if(G.running) return;
  if(G.over) reset();
  G.running = true; G.paused=false; G.t=0; G.last=now(); G.endAt = G.last + G.roundLen;
  setupRoad();
  clearIntervals(); setupIntervals(); // ANTI-PATTERN #8: intervals keep firing while paused
  requestAnimationFrame(loop);
  toast('Steer through traffic. Space = Nitro!');
}
function reset(){
  G.running=false; G.over=false; G.paused=false; G.t=0;
  G.p = {...G.p, x:G.W/2, y:420, vx:0, vy:0, nitro:100, nitroUntil:0, slipUntil:0, hits:0};
  G.cars.length=0; G.coins.length=0; G.cones.length=0; G.particles.length=0;
  G.score=0; G.stripeY=0; G.policeY=640; G.policeCatch=0; G.events=[];
  G.last=now(); G.endAt=G.last+G.roundLen;
  setupRoad(); clearIntervals(); setupIntervals(); updateHUD(); draw();
}
function gameOver(){
  G.running=false; G.over=true; clearIntervals();
  const sec = Math.round(G.roundLen/1000);
  $('summary').innerHTML = `
    <div class="stat"><h4>Score</h4><div class="big">${G.score}</div></div>
    <div class="stat"><h4>Time</h4><div class="big">${sec}s</div></div>
    <div class="stat"><h4>Hits</h4><div class="big">${G.p.hits}/3</div></div>
  `;
  if(G.score > G.high){ G.high = G.score; localStorage.setItem('tsr_high', G.high); }
  $('hs').textContent = G.high;
  $('gameOver').style.display='flex';
}

function togglePause(){
  if(!G.running) return;
  G.paused = !G.paused;
  toast(G.paused? 'Paused' : 'Resumed');
}

/* ========= Road & Lanes ========= */
function setupRoad(){
  G.laneX = [];
  const laneW = G.roadW / G.laneN;
  for(let i=0;i<G.laneN;i++){
    G.laneX.push(G.roadX + laneW*(i+0.5));
  }
}

/* ========= Spawners ========= */
// NOTE: Using setInterval leads to timers continuing during pause (ANTI-PATTERN #8).
function setupIntervals(){
  G.ivCars = setInterval(spawnTraffic, 800);
  G.ivCoins = setInterval(spawnCoin, 600);
  G.ivCones = setInterval(spawnCone, 2200);
  G.ivScoreTick = setInterval(()=>{ G.score += 5; updateHUD(); }, 250); // ANTI-PATTERN #9: score keeps increasing while paused
}
function clearIntervals(){
  [ 'ivCars','ivCoins','ivCones','ivScoreTick' ].forEach(k=>{ if(G[k]){ clearInterval(G[k]); G[k]=null; }});
}

/* ========= Loop ========= */
function loop(ts){
  if(!G.running){ return; }
  const elapsed = ts - G.last;

  // ANTI-PATTERN #4: 30 FPS cap & fixed dt (sluggish on fast monitors)
  if(elapsed < 33){ requestAnimationFrame(loop); return; }
  G.dt = 0.033; // ignores true dt
  G.t += G.dt; G.last = ts;

  if(!G.paused){ update(G.dt); }
  draw();

  if(ts >= G.endAt || G.p.hits>=3){ gameOver(); return; }
  requestAnimationFrame(loop);
}

/* ========= Update ========= */
function update(dt){
  // Road scroll
  G.stripeY += 320*dt;

  // Player control (with intentional input lag on steering) // ANTI-PATTERN #2
  const steerLeft = G.keys['ArrowLeft']||G.keys['KeyA'];
  const steerRight = G.keys['ArrowRight']||G.keys['KeyD'];
  const acc = (G.keys['ArrowUp']||G.keys['KeyW']) ? 1 : (G.keys['ArrowDown']||G.keys['KeyS']) ? -1 : 0;

  // Speed
  const maxSp = (G.p.nitroUntil>now()? G.p.maxSpeed*1.55 : G.p.maxSpeed); // ANTI-PATTERN #7: Nitro is overpowered + too long elsewhere
  G.p.speed = clamp(G.p.speed + acc*180*dt, 120, maxSp);
  const slip = (G.p.slipUntil>now()) ? 1.6 : 1.0;

  // Intentional steering delay
  if(steerLeft){ delayedSteer(-1*slip); }
  if(steerRight){ delayedSteer(+1*slip); }

  // Move
  G.p.x = clamp(G.p.x + G.p.vx*dt, G.roadX+30, G.roadX+G.roadW-30);
  G.p.y = clamp(G.p.y + (G.p.vy||0)*dt, 120, G.H-20);

  // Traffic moves down relative to player speed
  const rel = G.p.speed;
  for(const c of G.cars){ c.y += (rel*0.9 + c.v)*dt; }
  for(const co of G.coins){ co.y += (rel*0.85)*dt; }
  for(const cn of G.cones){ cn.y += (rel*0.88)*dt; }

  // Remove offscreen
  G.cars = G.cars.filter(c=>c.y < G.H+140);
  G.coins = G.coins.filter(c=>c.y < G.H+60);
  G.cones = G.cones.filter(c=>c.y < G.H+60);

  // Collisions (uses inflated AABB) // ANTI-PATTERN #1/#10
  for(let i=G.cars.length-1;i>=0;i--){
    if(aabbHit(G.p, G.cars[i])){
      hitCrash('car'); G.cars.splice(i,1);
      break;
    }
  }
  for(let i=G.cones.length-1;i>=0;i--){
    if(aabbHit(G.p, G.cones[i])){
      G.p.slipUntil = now()+1600; // oil/cone slip
      spawnBurst(G.cones[i].x, G.cones[i].y, '#f59e0b');
      beep(260,140,'triangle');
      G.cones.splice(i,1);
      break;
    }
  }
  for(let i=G.coins.length-1;i>=0;i--){
    if(aabbCollect(G.p, G.coins[i])){
      G.score += 50;
      spawnBurst(G.coins[i].x, G.coins[i].y, '#22c55e');
      beep(880,100,'square');
      G.coins.splice(i,1);
    }
  }

  // Police rubberband (too aggressive) // ANTI-PATTERN #5
  G.policeY = clamp(G.policeY - (G.p.speed*0.06) + (G.p.hits*4) - (G.p.nitroUntil>now()? 8 : 0), 520, 680);
  if(G.policeY <= 540){ // visible
    G.policeCatch += 0.35; // arbitrary catch meter
    if(G.policeCatch>100){ G.p.hits=3; } // instant bust
  } else {
    G.policeCatch = Math.max(0, G.policeCatch-0.15);
  }

  // Particles drift (never pruned) // ANTI-PATTERN #12
  for(const p of G.particles){ p.x+=p.vx*dt; p.y+=p.vy*dt; p.life+=dt; }

  updateHUD();
}

/* ========= Steering with lag ========= */
let steerTimer=null;
function delayedSteer(dir){
  if(steerTimer) return;
  // ANTI-PATTERN #2: add 100ms input lag on steering
  steerTimer = setTimeout(()=>{ G.p.vx = dir*220; steerTimer=null; }, 100);
}

/* ========= Collisions (inflated AABB) ========= */
// Player proxy rect bigger than sprite (unfair)
function aabbHit(p, o){
  const px = p.x - p.rHitX/2, py = p.y - p.rHitY/2, pw = p.rHitX, ph = p.rHitY; // ANTI-PATTERN #1
  const ox = o.x - o.w/2, oy = o.y - o.h/2;
  return !(px+pw < ox || px > ox+o.w || py+ph < oy || py > oy+o.h);
}
function aabbCollect(p, o){
  const px = p.x - (p.rHitX*0.8)/2, py = p.y - (p.rHitY*0.6)/2, pw=p.rHitX*0.8, ph=p.rHitY*0.6;
  const ox = o.x - o.r, oy = o.y - o.r, ow = o.r*2, oh = o.r*2;
  return !(px+pw < ox || px > ox+ow || py+ph < oy || py > oy+oh);
}

/* ========= Events ========= */
function spawnTraffic(){
  // ANTI-PATTERN #3: unfair spawns near player & clumping
  const lane = randi(0, G.laneX.length-1);
  const x = (Math.random()<0.2) ? G.p.x + rand(-40,40) : G.laneX[lane] + rand(-14,14);
  G.cars.push({x, y:-120, w:54, h:96, v:rand(20,80), color: (Math.random()<0.5?'#e11d48':'#6366f1')});
}
function spawnCoin(){
  const lane = randi(0, G.laneX.length-1);
  G.coins.push({x:G.laneX[lane] + rand(-18,18), y:-30, r:9});
}
function spawnCone(){
  const lane = randi(0, G.laneX.length-1);
  G.cones.push({x:G.laneX[lane] + rand(-18,18), y:-30, w:20, h:20});
}

/* ========= Reactions ========= */
function hitCrash(kind){
  G.p.hits++;
  if($('shakeOn').checked){ G.shakeA = 20; G.shakeT = 0.35; } // ANTI-PATTERN #13: too strong shake
  beep(220,160,'sawtooth');
  spawnBurst(G.p.x, G.p.y, '#ef4444');
  G.events.push({t:Math.round(G.t*1000), ev:'hit', kind, hits:G.p.hits});
}
function doNitro(){
  if(G.p.nitro<=0) return;
  // ANTI-PATTERN #7: Nitro lasts too long (6s) & boosts too much
  G.p.nitro -= 20;
  G.p.nitroUntil = now()+6000;
  toast('üî• NITRO!');
  beep(980,100,'square');
}

/* ========= Drawing ========= */
function draw(){
  const W=G.W, H=G.H;
  // Shake
  let offx=0, offy=0;
  if(G.shakeA>0 && G.shakeT>0){
    offx = (Math.random()*2-1)*G.shakeA;
    offy = (Math.random()*2-1)*G.shakeA;
    G.shakeT -= G.dt; if(G.shakeT<=0) G.shakeA=0;
  }
  ctx.save(); ctx.clearRect(0,0,W,H); ctx.translate(offx,offy);

  drawRoad(ctx);

  // Coins
  for(const c of G.coins){ ctx.beginPath(); ctx.fillStyle='#22c55e'; ctx.arc(c.x,c.y,c.r,0,6.283); ctx.fill(); }

  // Cones
  for(const c of G.cones){
    ctx.fillStyle='#f59e0b'; ctx.beginPath();
    ctx.moveTo(c.x, c.y-10); ctx.lineTo(c.x-10,c.y+10); ctx.lineTo(c.x+10,c.y+10); ctx.closePath(); ctx.fill();
  }

  // Traffic cars
  for(const c of G.cars){ drawCar(ctx, c.x, c.y, c.w, c.h, c.color); }

  // Player car
  drawCar(ctx, G.p.x, G.p.y, G.p.w, G.p.h, '#eab308', true);

  // Police strip
  drawPolice(ctx);

  // Particles (never pruned) // ANTI-PATTERN #12
  for(const p of G.particles){
    ctx.fillStyle = p.c; ctx.globalAlpha = Math.max(0, 1 - p.life/1.1);
    ctx.fillRect(p.x,p.y,2,2);
  }
  ctx.globalAlpha=1;
  ctx.restore();
}

function drawRoad(ctx){
  const W=G.W, H=G.H;
  // shoulders
  ctx.fillStyle=varCss('--shoulder'); ctx.fillRect(0,0,G.roadX,H); ctx.fillRect(G.roadX+G.roadW,0,W-(G.roadX+G.roadW),H);
  // road
  ctx.fillStyle=varCss('--road'); ctx.fillRect(G.roadX,0,G.roadW,H);

  // lane lines
  ctx.strokeStyle=varCss('--line'); ctx.lineWidth=2; ctx.setLineDash([24,20]);
  const laneW = G.roadW / G.laneN;
  const yOff = (G.stripeY%44);
  for(let i=1;i<G.laneN;i++){
    const x = G.roadX + laneW*i;
    ctx.beginPath(); ctx.moveTo(x, -20 + yOff); ctx.lineTo(x, H+20 + yOff); ctx.stroke();
  }
  ctx.setLineDash([]);

  // roadside instant KO? (No, but see collisions unfair) // FIXME consider soft walls
}

function drawCar(ctx, x,y,w,h, color, isPlayer=false){
  // body
  ctx.save(); ctx.translate(x,y);
  const g = ctx.createLinearGradient(0,-h/2,0,h/2);
  g.addColorStop(0, lighten(color,0.2)); g.addColorStop(1, darken(color,0.3));
  ctx.fillStyle=g; roundRect(ctx,-w/2,-h/2,w,h,10,true);

  // windows
  ctx.fillStyle='rgba(96,165,250,0.6)'; roundRect(ctx,-w*0.30,-h*0.30,w*0.60,h*0.28,6,true);

  // lights
  ctx.fillStyle='#fee2e2'; ctx.fillRect(-w*0.3, -h/2+4, w*0.6, 6);
  ctx.fillStyle='#fde68a'; ctx.fillRect(-w*0.3, h/2-10, w*0.6, 6);

  if(isPlayer && G.p.nitroUntil>now()){
    ctx.fillStyle='#60a5fa'; ctx.globalAlpha=0.9;
    ctx.beginPath(); ctx.moveTo(-w*0.2,h/2); ctx.lineTo(w*0.2,h/2); ctx.lineTo(0,h/2+rand(18,36)); ctx.closePath(); ctx.fill(); ctx.globalAlpha=1;
  }
  ctx.restore();
}

function drawPolice(ctx){
  // Siren bar at bottom indicating proximity
  const W=G.W, H=G.H;
  ctx.fillStyle='#0b1428'; ctx.fillRect(10,H-20,W-20,10);
  const catchPct = clamp(G.policeCatch,0,100)/100;
  ctx.fillStyle= catchPct>0.8 ? '#ef4444' : '#f59e0b';
  ctx.fillRect(10,H-20,(W-20)*catchPct,10);
}

function roundRect(ctx,x,y,w,h,r,fill){
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r);
  if(fill) ctx.fill(); else ctx.stroke();
}

function spawnBurst(x,y,color='#22c55e'){
  for(let i=0;i<10;i++){
    G.particles.push({x,y,vx:rand(-80,80),vy:rand(-80,80),life:0,c:color});
  }
}

/* ========= HUD ========= */
function updateHUD(){
  $('score').textContent = G.score;
  $('hits').textContent = G.p.hits;
  $('nitro').textContent = G.p.nitro+'%';
  const rem = Math.max(0, Math.round((G.endAt - now())/1000));
  $('timer').textContent = secToMMSS(rem);
  $('hs').textContent = G.high;
  if(G.score>=2000) unlock('üí´ 2K Club');
  if(G.p.hits===0 && rem<20) unlock('üõ°Ô∏è Clean Run (so far)');
}
function unlock(name){
  if(document.querySelector(`[data-ach="${name}"]`)) return;
  const s=document.createElement('span'); s.className='ach'; s.textContent=name; s.dataset.ach=name;
  $('achWrap').appendChild(s);
}

/* ========= Helpers ========= */
function varCss(name){ return getComputedStyle(document.documentElement).getPropertyValue(name); }
function lighten(hex, amt){ const c=parseInt(hex.slice(1),16); let r=(c>>16)+Math.round(255*amt), g=((c>>8)&255)+Math.round(255*amt), b=(c&255)+Math.round(255*amt); r=Math.min(255,r); g=Math.min(255,g); b=Math.min(255,b); return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1); }
function darken(hex, amt){ const c=parseInt(hex.slice(1),16); let r=(c>>16)-Math.round(255*amt), g=((c>>8)&255)-Math.round(255*amt), b=(c&255)-Math.round(255*amt); r=Math.max(0,r); g=Math.max(0,g); b=Math.max(0,b); return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1); }
function secToMMSS(s){ s=Math.max(0,Math.round(s)); const m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0'); }

/* ========= CSV ========= */
function exportCSV(){
  const rows = [];
  rows.push('t_ms,event,kind,score,hits,policeCatch');
  for(const e of G.events){ rows.push([e.t,e.ev,e.kind||'',G.score,G.p.hits,G.policeCatch].join(',')); }
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='turbo_racers_run.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ========= Missions Modal ========= */
function showMissions(){ $('missions').style.display='flex'; }

/* ========= Boot ========= */
function boot(){
  updateHUD();
  draw();
  $('timer').textContent = secToMMSS(Math.round(G.roundLen/1000));
  $('roundName').textContent = 'Neon Express';
  $('hs').textContent = G.high;
}
boot();

/* ========= INTENTIONALLY BAD CHOICES TO FIX =========
  #1  Oversized player hitbox vs sprite (unfair collisions):      p.rHitX/rHitY
  #2  Steering input lag (100 ms setTimeout in delayedSteer).
  #3  Unfair/clumped traffic spawns (near player without spacing).
  #4  30 FPS cap + fixed dt (ignores real frame time).
  #5  Police rubberband too aggressive (unfun catch-ups).
  #6  SFX volume too high & ignores SFX checkbox.
  #7  Nitro too strong and lasts too long (6s, x1.55 speed).
  #8  Pause doesn't stop spawners (setInterval keeps firing).
  #9  Score keeps increasing while paused (ivScoreTick).
  #10 Inflated AABB collision instead of tight polygon/car outline.
  #11 Touch controls are cosmetic only (not wired).
  #12 Particle leak (never pruned/capped ‚Äî memory churn).
  #13 Screen shake too strong & long on hit (motion sickness risk).
  #14 No color-blind/accessibility mode; color-only cues.
===================================================== */

/* ========= Example Fix Prompts (for students) =========
(Keep these here so students can copy and iterate. You can remove later.)

// 1) Align hitbox with sprite & separate collect radius
// "Open index.html. Reduce player hitbox to rHitX=50, rHitY=90 and update aabbHit to use those.
// Keep coin collection generous by using rHitX*0.7, rHitY*0.6 in aabbCollect. Show unified diff only."

// 2) Remove steering lag & make continuous
// "In delayedSteer(), remove setTimeout and set G.p.vx = dir*220 immediately on keydown,
// but decay vx toward 0 when no arrow keys are pressed. Acceptance: steering feels instant."

// 3) Make pause real
// "When paused, clear all intervals, and on resume, recreate them. Also freeze nitro/slip timers by storing remaining ms and resuming after unpause."

// 4) Uncap FPS and use real dt
// "In loop(ts), delete the elapsed<33 early return and compute dt=(ts-G.last)/1000, clamp dt<=0.05.
// Use dt everywhere; remove the fixed 0.033 assignment."

// 5) Balance nitro and rubberband
// "Set nitro boost to 1.2x for 2.5s; reduce police catch rate by half and add decay when player speeds up for 2s."

// 6) Wire SFX checkbox & tame volume
// "Change beep() to return if !$('sfxOn').checked and reduce default vol to 0.06."

// 7) De-clump traffic spawns
// "Before pushing a traffic car, ensure distance from player > 120px and from last 3 cars > 90px."

// 8) Particle cap & pruning
// "Each frame, remove particles with life>1.1 and cap total at 300 (drop oldest)."
===================================================== */
</script>
</body>
</html>
