<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Factory Quality Quest ‚Äî Learn QE by Playing</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Arcade factory game for Quality Engineering: SPC mini-game, acceptance sampling, gage error, drift, assignable causes, AOQ, Cpk, costs, profits, achievements." />
<style>
  :root{
    --bg:#0b1220; --panel:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --hl:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --card:#111827; --border:#243044; --accent:#60a5fa; --shadow:0 8px 30px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:linear-gradient(180deg,#0b1220,#0a1226 50%,#0a152c);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  header{max-width:1200px;margin:18px auto 8px;padding:0 14px;display:flex;align-items:center;gap:14px}
  header h1{font-size:20px;margin:0}
  .pill{background:#0e1a33;border:1px solid var(--border);border-radius:999px;padding:4px 10px;color:var(--muted);font-size:12px}
  .wrap{max-width:1200px;margin:0 auto;padding:0 14px 40px;display:grid;grid-template-columns:340px 1fr;gap:16px}
  @media (max-width:1050px){.wrap{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
  .left{padding:12px}
  .section{border:1px solid var(--border);border-radius:12px;background:#0c172e;margin:8px 0}
  .section h3{margin:0;padding:8px 10px;color:var(--muted);font-size:13px;border-bottom:1px solid var(--border)}
  .section .pad{padding:10px}
  label{display:flex;justify-content:space-between;gap:10px;align-items:center;margin:6px 0;color:#cdd5e1}
  input[type="number"], input[type="range"]{width:120px;background:#0b1428;border:1px solid var(--border);color:var(--ink);padding:6px;border-radius:8px}
  input[type="range"]{width:160px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{background:#14213a;border:1px solid #2b3a55;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer}
  button:hover{filter:brightness(1.1)}
  button.primary{background:#16a34a;border-color:#22c55e;color:#07150f;font-weight:700}
  button.danger{background:#7f1d1d;border-color:#ef4444}
  button.ghost{background:transparent;border-color:#334155;color:#cbd5e1}
  .meter{height:12px;border-radius:999px;background:#0b1428;border:1px solid var(--border);overflow:hidden}
  .meter>i{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#84cc16,#f59e0b,#ef4444);width:40%}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .stat{background:#0b1428;border:1px solid var(--border);border-radius:12px;padding:10px}
  .stat h4{margin:0 0 2px;font-size:12px;color:var(--muted)}
  .stat .big{font-weight:800;font-size:22px}
  .tiny{font-size:12px;color:var(--muted)}
  .game{position:relative;min-height:560px;padding:10px}
  .canvasWrap{background:linear-gradient(180deg,#0b1220,#0b1527);border:1px solid var(--border);border-radius:16px;padding:8px;display:grid;grid-template-rows:auto 200px 140px;gap:8px}
  .bar{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .bar .lefty,.bar .righty{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tag{padding:4px 10px;border:1px solid var(--border);border-radius:999px;color:#d1d5db;background:#0e1a33}
  canvas{background:#081018;border:1px solid var(--border);border-radius:12px}
  .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;border:1px solid #334155;padding:1px 6px;border-radius:6px;background:#0b1428;color:#cbd5e1}
  footer{max-width:1200px;margin:12px auto 40px;color:var(--muted);font-size:12px;padding:0 14px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#0b1428;border:1px solid var(--border);padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;transition:opacity .3s, transform .3s}
  .toast.show{opacity:1;transform:translate(-50%,-6px)}
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .box{max-width:900px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow)}
  .modal h2{margin:0 0 6px}
  .ach{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;margin:4px;border-radius:999px;border:1px solid var(--border);background:#0d162a}
</style>
</head>
<body>
<header>
  <h1>üè≠ Factory Quality Quest</h1>
  <span class="pill">Arcade + SPC + Sampling + Costs</span>
  <span class="pill">No installs ‚Ä¢ Works on GitHub Pages</span>
</header>

<div class="wrap">
  <!-- LEFT: Controls & Stats -->
  <div class="panel left">
    <div class="section">
      <h3>Game Controls</h3>
      <div class="pad row">
        <button class="primary" id="playBtn">‚ñ∂ Play</button>
        <button class="ghost" id="pauseBtn">‚è∏ Pause</button>
        <button class="ghost" id="resetBtn">‚Üª Reset</button>
        <button id="exportBtn" class="ghost">‚¨á Export CSV</button>
      </div>
      <div class="pad row tiny">
        <span>Round length</span>
        <input type="range" id="roundLen" min="60" max="300" value="180" />
        <span><span id="roundLenVal">180</span>s</span>
      </div>
    </div>

    <div class="section">
      <h3>Process & Spec</h3>
      <div class="pad">
        <label>LSL <input type="number" id="LSL" step="0.01" value="9.5"></label>
        <label>USL <input type="number" id="USL" step="0.01" value="10.5"></label>
        <label>Target Œº<sub>0</sub> <input type="number" id="mu0" step="0.01" value="10.0"></label>
        <label>Process œÉ <input type="number" id="sigma" step="0.01" value="0.15"></label>
        <label>Drift / 100 items <input type="number" id="driftPer100" step="0.005" value="0.02"></label>
        <label>Assignable cause prob/lot <input type="number" id="acProb" step="0.01" value="0.15"></label>
        <label>Assignable shift (√óœÉ) <input type="number" id="acSigmaMult" step="0.1" value="1.8"></label>
      </div>
    </div>

    <div class="section">
      <h3>Inspection & Costs</h3>
      <div class="pad">
        <div class="grid2">
          <label>Lot size (N)<input type="number" id="lotSize" value="80" min="10"></label>
          <label>Sample n<input type="number" id="sampleN" value="40" min="1"></label>
          <label>Accept c<input type="number" id="acceptC" value="2" min="0"></label>
          <label>Subgroup size nÃÑ<input type="number" id="subgroupN" value="5" min="2"></label>
        </div>
        <label>Gage œÉ as %Tol <input type="number" id="gagePctTol" value="7.5" step="0.1"></label>
        <div class="grid2">
          <label>Inspect $/sample <input type="number" id="inspectCost" value="0.05" step="0.01"></label>
          <label>Scrap $/part <input type="number" id="scrapCost" value="3.00" step="0.01"></label>
          <label>External failure $/escape <input type="number" id="extCost" value="30.00" step="0.01"></label>
          <label>Downtime $/stop <input type="number" id="stopCost" value="60.00" step="0.01"></label>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="stopBtn" class="danger">üõë STOP LINE (<span class="kbd">Space</span>)</button>
          <button id="maintBtn">üß∞ Maintenance (reduce œÉ)</button>
          <button id="calBtn">üß™ Calibrate Gage</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Scoreboard</h3>
      <div class="pad grid2">
        <div class="stat"><h4>Timer</h4><div class="big" id="timer">03:00</div><div class="tiny">Round length</div></div>
        <div class="stat"><h4>Profit</h4><div class="big" id="profit">$0</div><div class="tiny">Revenue ‚àí costs</div></div>
        <div class="stat"><h4>Cpk</h4><div class="big" id="cpk">‚Äî</div><div class="tiny">Capability</div></div>
        <div class="stat"><h4>AOQ</h4><div class="big" id="aoq">‚Äî</div><div class="tiny">Outgoing fraction defective</div></div>
        <div class="stat"><h4>% Accepted</h4><div class="big" id="pa">‚Äî</div><div class="tiny">Lots accepted</div></div>
        <div class="stat"><h4>DPMO</h4><div class="big" id="dpmo">‚Äî</div><div class="tiny">Defects per million</div></div>
      </div>
      <div class="pad">
        <div class="tiny">Customer satisfaction</div>
        <div class="meter"><i id="satisfactionBar" style="width:60%"></i></div>
      </div>
      <div class="pad tiny">
        <div>High score: <b id="hs">$0</b></div>
        <div id="achWrap" style="margin-top:6px"></div>
      </div>
    </div>

    <div class="section">
      <h3>In-class challenges</h3>
      <div class="pad tiny">
        Try: Change \((n,c)\) and gage %Tol; keep AOQ &lt; 1% while maximizing Profit.  
        Bonus: Hit STOP within 3 subgroups after an OOC point.  
        Advanced: Design your own double-sampling logic (n‚ÇÅ,c‚ÇÅ,n‚ÇÇ,c‚ÇÇ) and show AOQ ‚Üì.
      </div>
    </div>
  </div>

  <!-- RIGHT: Game Area -->
  <div class="panel game">
    <div class="canvasWrap">
      <div class="bar">
        <div class="lefty">
          <span class="tag">Conveyor: <b id="convRate">24</b> items/min</span>
          <span class="tag">Setpoint Œº<span id="muSet">10.00</span></span>
          <span class="tag">œÉ<span id="sigmaTag">0.15</span> | Gage œÉ%Tol <span id="gageTag">7.5</span></span>
          <span class="tag">Lot <b>#<span id="lotIdx">1</span></b>/<span id="lotCount">‚àû</span></span>
        </div>
        <div class="righty">
          <span class="tag">OOC detected? Watch XÃÑ ‚Üí <b class="tiny">hit STOP fast!</b></span>
        </div>
      </div>

      <!-- Main animation canvas -->
      <canvas id="gameCanvas" width="920" height="260" aria-label="Factory conveyor"></canvas>

      <!-- Xbar SPC canvas -->
      <canvas id="spcCanvas" width="920" height="200" aria-label="SPC chart"></canvas>

      <!-- Log -->
      <div style="border:1px solid var(--border);border-radius:12px;padding:8px;height:130px;overflow:auto;background:#0b1422" id="log"></div>
    </div>
  </div>
</div>

<footer>
  Tip: Press <span class="kbd">Space</span> to STOP LINE when the XÃÑ chart shows a point beyond UCL/LCL (Western Electric Rule 1).  
  Lots are sampled with your \((n,c)\) plan. Accepting ships all defects ‚Üí external failure cost; rejecting scraps whole lot.  
  Maintenance temporarily reduces œÉ; Calibrate temporarily reduces gage error.
</footer>

<!-- Tutorial / End modals -->
<div class="modal" id="tutorial">
  <div class="box">
    <h2>Welcome to <em>Factory Quality Quest</em> üéÆ</h2>
    <p>Produce lots, keep customers happy, and maximize profit by managing variation and inspection.</p>
    <ul>
      <li><b>SPC mini-game:</b> Watch the XÃÑ chart. If a point goes outside UCL/LCL (OOC), press <b>STOP LINE</b> (or Space) quickly.</li>
      <li><b>Acceptance sampling:</b> Pick <code>n</code> and <code>c</code>. Measured defects use your gage error; accepted lots ship all true defects (escapes).</li>
      <li><b>Events:</b> Assignable causes shift Œº; drift slowly moves the process. Maintenance reduces œÉ; Calibration improves gage temporarily.</li>
    </ul>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="closeTut" class="primary">Let‚Äôs play</button>
    </div>
  </div>
</div>

<div class="modal" id="gameOver">
  <div class="box">
    <h2>Round Complete</h2>
    <div id="summary"></div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="againBtn" class="primary">Play again</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Hello</div>

<script>
/* ===========================
   Utility & Audio
=========================== */
const log = (msg) => {
  const el = document.getElementById('log');
  const t = new Date().toLocaleTimeString();
  el.innerHTML = `<div class="tiny"><span style="color:#60a5fa">${t}</span> ‚Äî ${msg}</div>` + el.innerHTML;
};
const toast = (msg)=>{const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1600);};

let AC;
try{ AC = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){}
function beep(freq=600, ms=120, type='sine', vol=0.05){
  if(!AC) return;
  const o=AC.createOscillator(), g=AC.createGain();
  o.type=type; o.frequency.value=freq; g.gain.value=vol;
  o.connect(g); g.connect(AC.destination); o.start();
  setTimeout(()=>{o.stop();}, ms);
}

/* RNG */
function randn(){
  let u=0,v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function normal(mu, sigma){ return mu + sigma*randn(); }
function sampleWithoutReplacement(N, n){
  n = Math.min(n, N);
  const arr = Array.from({length:N}, (_,i)=>i);
  for(let i=0;i<n;i++){ const j = i + Math.floor(Math.random()*(N-i)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
  return arr.slice(0,n);
}

/* ===========================
   Game State
=========================== */
const state = {
  running:false, over:false, t:0, roundLen:180, lastFrame:0,
  // Process params
  LSL:9.5, USL:10.5, mu0:10.0, sigma:0.15, driftPer100:0.02,
  acProb:0.15, acSigmaMult:1.8,
  // Inspection
  lotSize:80, sampleN:40, acceptC:2, subgroupN:5, gagePctTol:7.5,
  // Costs
  inspectCost:0.05, scrapCost:3.0, extCost:30.0, stopCost:60.0,
  // Derived
  mu:10.0, sigmaCurr:0.15, gageSigma:0, driftPerItem:0.0002,
  convRatePerMin:24, // items per minute shown (visual)
  // Counters
  timeLeft:180, itemsMade:0, itemsThisLot:0, lotIdx:1, acceptedLots:0, totalLots:0,
  trueDefectsAll:0, escapesAll:0, resets:0,
  costInspect:0, costScrap:0, costExternal:0, costStops:0, revenue:0, pricePerUnit:1.2,
  satisfaction:70, highScore:0,
  // SPC
  subgroupBuf:[], xbarSeries:[], UCL:0, LCL:0, CL:0, oocFlag:false, oocSinceIdx:null,
  // Visual
  items:[], // animated items on conveyor
  // Timed effects
  maintUntil:0, calUntil:0,
  // Logs
  lots:[],
};

/* Bind UI inputs */
const $ = (id)=>document.getElementById(id);
function bindInputs(){
  const ids = ["LSL","USL","mu0","sigma","driftPer100","acProb","acSigmaMult","lotSize","sampleN","acceptC","subgroupN","gagePctTol","inspectCost","scrapCost","extCost","stopCost"];
  for(const id of ids){
    $(id).addEventListener('change', ()=>{
      let v = Number($(id).value);
      if(id==="sampleN") v = Math.max(1, Math.floor(v));
      if(id==="acceptC") v = Math.max(0, Math.floor(v));
      if(id==="subgroupN") v = Math.max(2, Math.floor(v));
      state[id] = v;
      recalcDerived();
      displayParams();
    });
  }
  $('roundLen').addEventListener('input', e=>{ $('roundLenVal').textContent = e.target.value; });
  $('roundLen').addEventListener('change', e=>{ state.roundLen = Number(e.target.value); if(!state.running) { state.timeLeft = state.roundLen; updateTimer(); }});
  $('playBtn').addEventListener('click', startGame);
  $('pauseBtn').addEventListener('click', pauseGame);
  $('resetBtn').addEventListener('click', resetGame);
  $('exportBtn').addEventListener('click', exportCSV);
  $('stopBtn').addEventListener('click', stopLine);
  $('maintBtn').addEventListener('click', doMaintenance);
  $('calBtn').addEventListener('click', calibrateGage);
  $('closeTut').addEventListener('click', ()=>{ $('tutorial').style.display='none'; });
  $('againBtn').addEventListener('click', ()=>{ $('gameOver').style.display='none'; resetGame(); startGame(); });
  window.addEventListener('keydown', (e)=>{ if(e.code==='Space'){ e.preventDefault(); stopLine(); }});
}

/* Derived params & display */
function recalcDerived(){
  state.gageSigma = (state.gagePctTol/100) * (state.USL - state.LSL);
  state.driftPerItem = state.driftPer100 / 100.0;
  state.mu = state.mu0;
  state.sigmaCurr = state.sigma;
  const s = state.sigmaCurr/Math.sqrt(state.subgroupN);
  state.UCL = state.mu0 + 3*s; state.LCL = state.mu0 - 3*s; state.CL = state.mu0;
}
function displayParams(){
  $('muSet').textContent = state.mu0.toFixed(2);
  $('sigmaTag').textContent = state.sigmaCurr.toFixed(2);
  $('gageTag').textContent = state.gagePctTol.toFixed(1);
  $('lotIdx').textContent = state.lotIdx;
  $('lotCount').textContent = '‚àû';
  $('convRate').textContent = state.convRatePerMin;
}

/* ===========================
   Game Loop & Simulation
=========================== */
const g = {
  game: $('gameCanvas').getContext('2d'),
  spc: $('spcCanvas').getContext('2d'),
};
function startGame(){
  if(state.over) resetGame();
  if(!state.running){
    state.running = true;
    state.lastFrame = performance.now();
    $('tutorial').style.display='none';
    requestAnimationFrame(frame);
  }
}
function pauseGame(){ state.running = false; }
function resetGame(){
  state.running=false; state.over=false;
  state.timeLeft = state.roundLen; updateTimer();
  state.itemsMade=0; state.itemsThisLot=0; state.lotIdx=1; state.acceptedLots=0; state.totalLots=0;
  state.trueDefectsAll=0; state.escapesAll=0; state.resets=0;
  state.costInspect=0; state.costScrap=0; state.costExternal=0; state.costStops=0; state.revenue=0;
  state.satisfaction=70; state.oocFlag=false; state.oocSinceIdx=null;
  state.subgroupBuf=[]; state.xbarSeries=[]; state.items=[]; state.lots=[];
  state.maintUntil=0; state.calUntil=0;
  recalcDerived(); displayParams(); drawAll();
  $('timer').textContent = secToMMSS(state.timeLeft);
  log('üîÑ Game reset.');
  $('tutorial').style.display='flex';
}
function frame(ts){
  if(!state.running) return;
  const dt = Math.min(0.06, (ts - state.lastFrame)/1000); // cap dt
  state.lastFrame = ts;
  tick(dt);
  drawAll();
  requestAnimationFrame(frame);
}
function tick(dt){
  // Timer
  state.t += dt;
  state.timeLeft -= dt;
  if(state.timeLeft <= 0){ endGame(); return; }
  updateTimer();

  // Produce items according to conveyor rate
  const itemsPerSec = state.convRatePerMin/60;
  const toProduce = itemsPerSec*dt + g._carry || 0;
  let nMake = Math.floor(toProduce);
  g._carry = toProduce - nMake;

  for(let k=0;k<nMake;k++) produceItem();

  // Animated items movement
  for(const it of state.items){ it.x += it.vx*dt; }
  // remove offscreen
  state.items = state.items.filter(it=> it.x < $('gameCanvas').width + 40);

  // Effects decay
  if(state.maintUntil>0 && performance.now() > state.maintUntil){ state.sigmaCurr = state.sigma; $('sigmaTag').textContent = state.sigmaCurr.toFixed(2); toast('üß∞ Maintenance effect ended'); }
  if(state.calUntil>0 && performance.now() > state.calUntil){ state.gagePctTol = Number($('gagePctTol').value); state.gageSigma = (state.gagePctTol/100)*(state.USL-state.LSL); $('gageTag').textContent = state.gagePctTol.toFixed(1); toast('üß™ Calibration effect ended'); }

  // Satisfaction drift
  state.satisfaction = Math.max(0, Math.min(100, state.satisfaction + 0.01*dt));
  $('satisfactionBar').style.width = state.satisfaction + '%';
}
function endGame(){
  state.running=false; state.over=true;
  // compute summary stats
  const N = state.lotSize * state.totalLots || 1;
  const aoq = state.escapesAll / N;
  const dpmo = (state.trueDefectsAll / N) * 1e6;
  const cpk = computeCpk();
  const inspect = state.costInspect, scrap=state.costScrap, ext=state.costExternal, stops=state.costStops;
  const profit = state.revenue - (inspect+scrap+ext+stops);
  if(profit > (state.highScore||0)){ state.highScore = profit; localStorage.setItem('fq_high', String(profit)); }
  $('hs').textContent = fmtMoney(state.highScore);
  $('summary').innerHTML = `
    <div class="grid2">
      <div class="stat"><h4>Profit</h4><div class="big">${fmtMoney(profit)}</div><div class="tiny">Revenue ‚Äì all costs</div></div>
      <div class="stat"><h4>AOQ</h4><div class="big">${(aoq*100).toFixed(2)}%</div><div class="tiny">Outgoing fraction defective</div></div>
      <div class="stat"><h4>Cpk</h4><div class="big">${cpk.toFixed(2)}</div></div>
      <div class="stat"><h4>DPMO</h4><div class="big">${Math.round(dpmo).toLocaleString()}</div></div>
      <div class="stat"><h4>Lots Accepted</h4><div class="big">${state.acceptedLots}/${state.totalLots}</div></div>
    </div>
    <div class="tiny" style="margin-top:8px">
      Costs ‚Üí Inspect: ${fmtMoney(inspect)} | Scrap: ${fmtMoney(scrap)} | External: ${fmtMoney(ext)} | Downtime: ${fmtMoney(stops)}.
    </div>
  `;
  $('gameOver').style.display='flex';
}

/* Produce one item, update subgroup, maybe finish lot */
function produceItem(){
  // Assignable cause at lot start
  if(state.itemsThisLot===0 && Math.random() < state.acProb){
    const shift = state.acSigmaMult * state.sigmaCurr * randn();
    state.mu += shift;
    log(`‚ö†Ô∏è Assignable cause shifted Œº by ${shift.toFixed(3)}`);
    beep(320,130,'square',0.06);
  }
  // Drift
  state.mu += state.driftPerItem;

  // Make item
  const trueX = normal(state.mu, state.sigmaCurr);
  const isDef = (trueX < state.LSL || trueX > state.USL);
  state.trueDefectsAll += isDef ? 1 : 0;
  state.itemsThisLot++; state.itemsMade++;

  // Revenue from good unit is only realized when lot accepted (we book at shipment to keep it simple)
  // Visual item
  spawnVisualItem(trueX, isDef);

  // SPC subgrouping
  state.subgroupBuf.push(trueX);
  if(state.subgroupBuf.length === state.subgroupN){
    const mean = state.subgroupBuf.reduce((a,b)=>a+b,0)/state.subgroupN;
    state.xbarSeries.push(mean);
    state.subgroupBuf = [];
    // Rule 1: point beyond 3œÉ/‚àön
    if(mean>state.UCL || mean<state.LCL){
      if(!state.oocFlag){ state.oocFlag=true; state.oocSinceIdx = state.xbarSeries.length-1; log('üö® OOC detected! Hit STOP to investigate.'); toast('üö® Out-of-Control! STOP the line!'); beep(220,220,'sawtooth',0.08); }
    }
  }

  // End of lot?
  if(state.itemsThisLot >= state.lotSize){
    finishLot();
  }
}

/* Finish current lot: apply acceptance sampling with gage error */
function finishLot(){
  const L = state.lotIdx;
  const startIdx = state.itemsMade - state.itemsThisLot;
  const endIdx = state.itemsMade; // not used for raw items storage; we simulate sample from this lot via visual item store selection
  // Because we don't store all true values per lot (to save memory), we estimate using sampled items + tracked defects:
  // Here we *do* have real defects count for the lot by scanning recent visual items flagged lot=L
  const lastLotItems = state.items.filter(it=>it.lot===L);
  const lotDefectsTrue = lastLotItems.filter(it=>it.isDef).length;

  // Sample n with gage error
  const n = Math.min(state.sampleN, state.lotSize);
  const idx = sampleWithoutReplacement(lastLotItems.length, n);
  let measuredDef = 0;
  for(const i of idx){
    const meas = lastLotItems[i].trueX + normal(0, state.gageSigma);
    if(meas<state.LSL || meas>state.USL) measuredDef++;
  }
  const accepted = (measuredDef <= state.acceptC);
  state.costInspect += state.inspectCost * n;

  if(accepted){
    state.acceptedLots++;
    // All true defects in accepted lot are escapes
    state.escapesAll += lotDefectsTrue;
    state.costExternal += lotDefectsTrue * state.extCost;
    // Book revenue for good parts in the lot (N - true defects)
    const good = state.lotSize - lotDefectsTrue;
    state.revenue += good * state.pricePerUnit;
    state.satisfaction = Math.max(0, state.satisfaction - lotDefectsTrue*0.8); // customers annoyed by escapes
    log(`üì¶ Lot #${L} ACCEPTED (measured ${measuredDef} ‚â§ c=${state.acceptC}). Escapes:${lotDefectsTrue}.`);
    beep(880,120,'triangle',0.07);
  }else{
    state.costScrap += state.scrapCost * state.lotSize;
    state.satisfaction = Math.max(0, state.satisfaction - 3); // delays
    log(`üóëÔ∏è Lot #${L} REJECTED (measured ${measuredDef} > c=${state.acceptC}). Scrapped.`);
    beep(180,160,'sawtooth',0.07);
  }

  state.totalLots++;
  // Reset lot counters
  state.itemsThisLot = 0; state.lotIdx++; $('lotIdx').textContent = state.lotIdx;

  // Achievements
  if(state.acceptedLots>=3) unlock('‚úÖ 3 Accepted Lots');
  if(state.escapesAll===0 && state.totalLots>=2) unlock('üåü Zero Escapes (so far)');

  // Occasionally, auto-drift small negative to satisfaction recover
  state.satisfaction = Math.min(100, state.satisfaction + 1.5);
}

/* STOP line: costs downtime, resets Œº to Œº0 and clears OOC flag */
function stopLine(){
  // Only meaningful if OOC
  state.costStops += state.stopCost;
  state.mu = state.mu0;
  state.oocFlag=false; state.oocSinceIdx=null;
  state.resets++;
  state.satisfaction = Math.min(100, state.satisfaction + 4);
  log('üõë Line stopped & centered to Œº‚ÇÄ. OOC cleared.');
  toast('Line investigated. Back to target.');
  beep(520,120,'square',0.06);
}

/* Maintenance: temporarily reduce œÉ by 30% for 30s */
function doMaintenance(){
  const until = performance.now() + 30000;
  state.sigmaCurr = Math.max(0.05, state.sigma * 0.7);
  state.maintUntil = until;
  $('sigmaTag').textContent = state.sigmaCurr.toFixed(2);
  log('üß∞ Maintenance: œÉ reduced by 30% for 30s.');
  unlock('üß∞ Preventive Strike');
  beep(640,120,'triangle',0.06);
}

/* Calibration: temporarily halves gage %Tol for 25s */
function calibrateGage(){
  const until = performance.now() + 25000;
  state.gagePctTol = Number($('gagePctTol').value);
  const newPct = state.gagePctTol/2;
  state.calUntil = until;
  state.gageSigma = (newPct/100)*(state.USL-state.LSL);
  $('gageTag').textContent = newPct.toFixed(1);
  log('üß™ Calibration: gage œÉ%Tol halved for 25s.');
  unlock('üß™ Tight Readings');
  beep(700,100,'sine',0.05);
}

/* Visual items (conveyor) */
let lotColorA = '#22c55e', lotColorB = '#eab308';
function spawnVisualItem(trueX, isDef){
  const ctx = g.game.canvas;
  const yBase = ctx.height-60, lane = 0;
  const it = {
    x: -20, y: yBase - lane*22,
    vx: 140, // px/s
    trueX, isDef,
    lot: state.lotIdx,
    color: isDef ? '#ef4444' : (state.lotIdx%2 ? lotColorA : lotColorB)
  };
  state.items.push(it);
}

/* ===========================
   Drawing
=========================== */
function drawAll(){
  drawFactory();
  drawSPC();
  updateHUD();
}
function drawFactory(){
  const ctx = g.game; const W = ctx.canvas.width, H = ctx.canvas.height;
  ctx.clearRect(0,0,W,H);

  // floor & conveyor
  ctx.fillStyle = '#0d1b2a'; ctx.fillRect(0,H-40,W,40);
  ctx.fillStyle = '#0a1323'; ctx.fillRect(0,H-80,W,40);
  // rollers
  for(let x=0;x<W;x+=60){
    ctx.beginPath(); ctx.arc(x+(Date.now()/30)%60, H-60, 8, 0, Math.PI*2);
    ctx.fillStyle = '#1f2937'; ctx.fill();
  }
  // machine
  ctx.fillStyle = '#142a4a'; roundRect(ctx, 20, 20, 210, 120, 12, true);
  ctx.fillStyle = '#0d213f'; roundRect(ctx, 30, 30, 190, 60, 8, true);
  ctx.fillStyle = '#1e3a8a'; roundRect(ctx, 30, 96, 190, 32, 8, true);
  // gauges
  drawGauge(ctx, 46, 44, state.mu - state.mu0, -0.5, 0.5, 'ŒîŒº');
  drawGauge(ctx, 114, 44, state.sigmaCurr, 0.05, 0.3, 'œÉ');
  drawGauge(ctx, 182, 44, state.gageSigma, 0, (state.USL-state.LSL)*0.2, 'gage œÉ');

  // items
  for(const it of state.items){
    ctx.beginPath();
    ctx.fillStyle = it.color;
    ctx.strokeStyle = '#020617';
    ctx.lineWidth = 1.2;
    ctx.arc(it.x, it.y, 7.5, 0, Math.PI*2);
    ctx.fill(); ctx.stroke();
  }

  // labels
  ctx.fillStyle = '#9ca3af';
  ctx.fillText(`Lot #${state.lotIdx}`, W-100, 18);
  if(state.oocFlag){
    ctx.fillStyle = '#ef4444';
    ctx.font = 'bold 14px system-ui';
    ctx.fillText('OOC! STOP!', W-110, 36);
    ctx.font = '15px system-ui';
  }
}
function roundRect(ctx,x,y,w,h,r,fill){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  if(fill) ctx.fill();
  else ctx.stroke();
}
function drawGauge(ctx, cx, cy, val, vmin, vmax, label){
  const r=12;
  const t = Math.max(0, Math.min(1, (val-vmin)/(vmax-vmin)));
  ctx.fillStyle = '#0b1428'; ctx.strokeStyle = '#1f2b44';
  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx, cy); const ang = -Math.PI*0.75 + 1.5*Math.PI*t; ctx.lineTo(cx + r*Math.cos(ang), cy + r*Math.sin(ang)); ctx.strokeStyle='#60a5fa'; ctx.stroke();
  ctx.fillStyle = '#93c5fd'; ctx.font='10px system-ui'; ctx.fillText(label, cx-10, cy+26);
}
function drawSPC(){
  const ctx = g.spc; const W=ctx.canvas.width, H=ctx.canvas.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = '#06101b'; ctx.fillRect(0,0,W,H);
  // axes
  ctx.strokeStyle = '#203047'; ctx.beginPath(); ctx.moveTo(40,10); ctx.lineTo(40,H-30); ctx.lineTo(W-10,H-30); ctx.stroke();
  // compute y scale
  const vals = state.xbarSeries.slice(-80);
  if(vals.length===0) return;
  const min = Math.min(state.LCL, ...vals)-0.05;
  const max = Math.max(state.UCL, ...vals)+0.05;
  const yOf = v => (H-30) - (v-min)/(max-min)*(H-50);
  const x0 = 42, dx = (W-60)/Math.max(20, vals.length);

  // CL/UCL/LCL
  ctx.strokeStyle = '#38bdf8'; drawH(ctx, yOf(state.CL), x0, W-14, [5,4]);
  ctx.strokeStyle = '#94a3b8'; drawH(ctx, yOf(state.UCL), x0, W-14, [2,4]);
  ctx.strokeStyle = '#94a3b8'; drawH(ctx, yOf(state.LCL), x0, W-14, [2,4]);

  // series
  ctx.strokeStyle = '#22c55e'; ctx.lineWidth=1.2; ctx.beginPath();
  vals.forEach((m,i)=>{ const x = x0 + i*dx; const y=yOf(m); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke();

  // OOC markers
  vals.forEach((m,i)=>{ if(m>state.UCL || m<state.LCL){ const x=x0+i*dx, y=yOf(m); ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.arc(x,y,3,0,6.28); ctx.fill(); }});

  // labels
  ctx.fillStyle='#93a3b5'; ctx.font='11px system-ui';
  ctx.fillText('XÃÑ', 8, 14);
  ctx.fillText('UCL', 6, yOf(state.UCL)+4);
  ctx.fillText('CL', 6, yOf(state.CL)+4);
  ctx.fillText('LCL', 6, yOf(state.LCL)+4);
}
function drawH(ctx, y, x1, x2, dash){
  ctx.setLineDash(dash||[]); ctx.beginPath(); ctx.moveTo(x1,y); ctx.lineTo(x2,y); ctx.stroke(); ctx.setLineDash([]);
}

/* HUD updates */
function updateHUD(){
  // KPIs
  const N = state.lotSize * Math.max(1, state.totalLots);
  const aoq = (N>0) ? (state.escapesAll / N) : 0;
  $('aoq').textContent = (aoq*100).toFixed(2)+'%';
  $('dpmo').textContent = Math.round((state.trueDefectsAll/(N||1))*1e6).toLocaleString();
  $('pa').textContent = (state.totalLots>0 ? (state.acceptedLots/state.totalLots*100).toFixed(1) : '‚Äî') + '%';
  $('cpk').textContent = computeCpk().toFixed(2);
  const profit = state.revenue - (state.costInspect + state.costScrap + state.costExternal + state.costStops);
  $('profit').textContent = fmtMoney(profit);
  $('hs').textContent = fmtMoney(state.highScore || Number(localStorage.getItem('fq_high')||0));
}

/* Helpers */
function computeCpk(){
  // Estimate from last ~400 true items using normal approx (we don't store all; sample from visuals by value)
  const vals = state.items.slice(-400).map(v=>v.trueX);
  if(vals.length<3) return 0;
  const mean = vals.reduce((a,b)=>a+b,0)/vals.length;
  const sd = Math.sqrt(vals.reduce((s,x)=>s+(x-mean)*(x-mean),0)/(vals.length-1));
  return Math.min((state.USL-mean)/(3*sd),(mean-state.LSL)/(3*sd)) || 0;
}
function fmtMoney(x){ return '$'+(Math.round(x*100)/100).toFixed(2); }
function secToMMSS(s){ s=Math.max(0,Math.round(s)); const m=Math.floor(s/60), r=s%60; return String(m).padStart(2,'0')+':'+String(r).padStart(2,'0'); }
function updateTimer(){ $('timer').textContent = secToMMSS(state.timeLeft); }

/* Achievements */
const got = new Set();
function unlock(name){
  if(got.has(name)) return;
  got.add(name);
  const b = document.createElement('span');
  b.className='ach'; b.textContent=name;
  $('achWrap').appendChild(b);
}

/* CSV Export */
function exportCSV(){
  const lines = [];
  lines.push('Metric,Value');
  lines.push(`LSL,${state.LSL}`); lines.push(`USL,${state.USL}`); lines.push(`mu0,${state.mu0}`); lines.push(`sigma,${state.sigma}`);
  lines.push(`lotSize,${state.lotSize}`); lines.push(`sampleN,${state.sampleN}`); lines.push(`acceptC,${state.acceptC}`); lines.push(`subgroupN,${state.subgroupN}`);
  lines.push(`gagePctTol,${state.gagePctTol}`); lines.push(`driftPer100,${state.driftPer100}`); lines.push(`acProb,${state.acProb}`); lines.push(`acSigmaMult,${state.acSigmaMult}`);
  lines.push(`inspectCost,${state.inspectCost}`); lines.push(`scrapCost,${state.scrapCost}`); lines.push(`extCost,${state.extCost}`); lines.push(`stopCost,${state.stopCost}`);

  const N = state.lotSize * Math.max(1, state.totalLots);
  const aoq = (N>0) ? (state.escapesAll / N) : 0;
  const dpmo = (state.trueDefectsAll/(N||1))*1e6;
  lines.push(`AOQ,${aoq}`);
  lines.push(`DPMO,${dpmo}`);
  lines.push(`LotsAccepted,${state.acceptedLots}`);
  lines.push(`TotalLots,${state.totalLots}`);
  lines.push(`Resets,${state.resets}`);
  lines.push(`Revenue,${state.revenue}`);
  lines.push(`CostInspect,${state.costInspect}`);
  lines.push(`CostScrap,${state.costScrap}`);
  lines.push(`CostExternal,${state.costExternal}`);
  lines.push(`CostStops,${state.costStops}`);
  lines.push('');

  lines.push('Xbar Series (most recent first)');
  lines.push('index,xbar');
  state.xbarSeries.forEach((m,i)=> lines.push(`${i},${m}`));

  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='factory_quality_quest.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ===========================
   Boot
=========================== */
bindInputs();
recalcDerived();
displayParams();
resetGame();

/* Show tutorial on first load only */
if(!localStorage.getItem('fq_seen')){
  $('tutorial').style.display='flex';
  localStorage.setItem('fq_seen','1');
}

/* Small helpers for canvas draws above */
function drawText(ctx, txt, x,y,color='#cbd5e1',size=12){ctx.fillStyle=color;ctx.font=`${size}px system-ui`;ctx.fillText(txt,x,y);}
</script>
</body>
</html>
